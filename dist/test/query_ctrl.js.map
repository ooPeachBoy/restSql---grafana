{"version":3,"sources":["../../src/query_ctrl.js"],"names":["GenericDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","$q","scope","lastQueryError","panelCtrl","events","on","PanelEvents","dataReceived","onDataReceived","bind","dataError","onDataError","formats","text","value","types","console","log","target","type","tableSegment","newSegment","table","selectionsParts","selectionsList","forEach","element","__proto__","toLocaleString","express","sqlPart","create","part","push","selectionAdd","newPlusButton","selectMenu","whereParts","whereList","whereAdd","aggParts","aggList","aggAdd","groupParts","groupList","groupAdd","joinQueryList","sortParts","sortList","sortAdd","fieldParts","fieldList","fieldAdd","limitSegment","limit","query","dataList","err","message","options","Promise","resolve","parts","index","_","indexOf","splice","updateRestSql","joinIndex","getOptions","params","resetPlusButton","event","name","when","action","removePart","item","i","expIndex","selections","param","operators","newOperators","where","aggs","groups","onAdd","export","exportAdd","getExportOptions","getAllFields","button","plusButton","html","queryObj","mainFields","exportFields","concat","aggFunc","field","join","select","from","fields","operatorToSuffix","suffix","key","filter","JSON","parse","startsWith","endsWith","tmpStr","slice","length","isNaN","parseFloat","toLowerCase","reject","aggregation","group_by","joinQuery","sortExp","sort","parseInt","stringify","refresh","QueryCtrl","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import './css/query-editor.css!'\r\n\r\nimport _ from 'lodash';\r\nimport { QueryCtrl } from 'app/plugins/sdk';\r\nimport sqlPart from './sql_part';\r\nimport { PanelEvents } from '@grafana/data';\r\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\r\n\r\n  constructor($scope, $injector, uiSegmentSrv, $q) {\r\n    super($scope, $injector);\r\n    this.scope = $scope;\r\n    this.uiSegmentSrv = uiSegmentSrv;\r\n    this.$q = $q;\r\n    this.lastQueryError = null;\r\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\r\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\r\n\r\n    this.formats = [\r\n      { text: 'Time series', value: 'grafana.timeserie' },\r\n      { text: 'Table', value: 'grafana.table' },\r\n    ];\r\n    this.types = [\r\n      { text: 'Left Join', value: 'left_join' },\r\n      { text: 'Inner Join', value: 'inner_join' },\r\n      { text: 'Full Join', value: 'full_join' }\r\n    ];\r\n\r\n    console.log(this.target, 11111111111111111111);\r\n\r\n    // this.target.tableSegment = null;\r\n    this.target.target = this.target.target || '';\r\n    this.target.type = this.target.type;\r\n\r\n    this.target.tableSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.table || 'select table', \"fake\": true });\r\n    this.target.table = this.target.table || this.target.tableSegment.value;\r\n\r\n    if (this.target.selectionsParts) {\r\n      let selectionsList=[]\r\n      this.target.selectionsParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          selectionsList.push(express);\r\n        }\r\n        this.target.selectionsParts=  selectionsList\r\n      });\r\n    } else {\r\n      this.target.selectionsParts =  [];\r\n    }\r\n  \r\n    this.selectionAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n    this.selectMenu = [];\r\n    this.selectMenu.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\r\n\r\n\r\n    if (this.target.whereParts) {\r\n      let whereList = []\r\n      this.target.whereParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          whereList.push(express);\r\n        }\r\n        this.target.whereParts = whereList\r\n      });\r\n    } else {\r\n      this.target.whereParts = [];\r\n    }\r\n\r\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n\r\n    this.target.aggParts = this.target.aggParts || [];\r\n    if (this.target.aggParts) {\r\n      let aggList = []\r\n      this.target.aggParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          aggList.push(express);\r\n        }\r\n        this.target.aggParts = aggList\r\n      });\r\n    } else {\r\n      this.target.aggParts = [];\r\n    }\r\n    this.aggAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n    if (this.target.groupParts) {\r\n      let groupList = []\r\n      this.target.groupParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          groupList.push(express);\r\n        }\r\n        this.target.groupParts = groupList\r\n      });\r\n    } else {\r\n      this.target.groupParts = [];\r\n    }\r\n\r\n\r\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n    if (this.target.joinQueryList) {\r\n      let joinQueryList = []\r\n      this.target.joinQueryList.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          joinQueryList.push(express);\r\n        }\r\n        this.target.joinQueryList = joinQueryList\r\n      });\r\n    } else {\r\n      this.target.joinQueryList = [];\r\n    }\r\n\r\n\r\n    if (this.target.sortParts) {\r\n      let sortList = []\r\n      this.target.sortParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          sortList.push(express);\r\n        }\r\n        this.target.sortParts = sortList\r\n      });\r\n    } else {\r\n      this.target.sortParts = [];\r\n    }\r\n\r\n    this.sortAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n    if (this.target.fieldParts) {\r\n      let fieldList = []\r\n      this.target.fieldParts.forEach(element => {\r\n        if (element.__proto__.toLocaleString) {\r\n          const express = sqlPart.create(element.part)\r\n          fieldList.push(express);\r\n        }\r\n        this.target.fieldParts = fieldList\r\n      });\r\n    } else {\r\n      this.target.fieldParts = [];\r\n    }\r\n\r\n\r\n    this.fieldAdd = this.uiSegmentSrv.newPlusButton();\r\n\r\n    this.target.limitSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.limit || '1000', \"fake\": true });\r\n    this.target.limit = this.target.limitSegment.value || '1000';\r\n    this.target.query = {\r\n      // restSql协议结构定义\r\n      \"select\": {\r\n        \"from\": \"\",\r\n        \"filter\": {},\r\n        \"group_by\": [],\r\n        \"aggregation\": [],\r\n        \"sort\": [],\r\n      },\r\n      \"join\": [],\r\n      \"sort\": [],\r\n      \"fields\": [],\r\n      \"limit\": 200\r\n    };\r\n\r\n  }\r\n  onDataReceived(dataList) {\r\n    console.log(dataList);\r\n    this.lastQueryError = null\r\n  }\r\n  onDataError(err) {\r\n    if (this.target.target) {\r\n      this.lastQueryError = err.message\r\n    } \r\n   \r\n  }\r\n\r\n  getOptions() {\r\n    const options = [];\r\n    options.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\r\n    console.log(\"tttttt getOptions\", options);\r\n    return Promise.resolve(options);\r\n  }\r\n\r\n  removePart(parts, part) {\r\n    const index = _.indexOf(parts, part);\r\n    parts.splice(index, 1);\r\n  }\r\n\r\n  onFormatChanged() {\r\n    console.log(\"onFormatChanged\", this);\r\n    this.updateRestSql();\r\n  }\r\n\r\n  onTableChanged() {\r\n    console.log(\"tableChanged\", this);\r\n    this.target.table = this.target.tableSegment.value;\r\n    this.updateRestSql();\r\n  }\r\n\r\n  onJoinTableChanged(joinIndex) {\r\n    console.log(\"onJoinTableChanged\", joinIndex);\r\n    // this.target.joinQueryList[joinIndex].table = ;\r\n    this.updateRestSql();\r\n  }\r\n\r\n  onLimitChanged() {\r\n    // console.log(\"onLimitChanged\");\r\n    this.target.limit = this.target.limitSegment.value;\r\n    this.updateRestSql();\r\n  }\r\n\r\n  addSelectionAction(part, index) {\r\n    console.log(1111, part, index);\r\n    this.getOptions()\r\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\r\n    this.target.selectionsParts.push(express);\r\n    this.resetPlusButton(this.selectionAdd);\r\n\r\n  }\r\n\r\n  handleSelectionsPartEvent(part, index, event) {\r\n    console.log(\"tttttt handleSelectionsPartEvent\", event, index, part, '---');\r\n    // if (event.name = \"get-param-options\")\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.removePart(this.target.selectionsParts, part);\r\n      // this.target.selectionsParts.splice(index, 1, null);\r\n      this.updateRestSql()\r\n      console.log(this.target.selectionsParts, '------')\r\n    } else if (event.name === \"part-param-changed\") {\r\n      console.log(this.target.selectionsParts);\r\n      this.target.selectionsParts.forEach((item, i) => {\r\n      })\r\n      this.updateRestSql();\r\n    }\r\n  }\r\n\r\n  addJoinSelectionAction(joinIndex, expIndex) {\r\n    console.log(\"addJoinSelectionAction\", joinIndex, expIndex);\r\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\r\n    this.target.joinQueryList[joinIndex].selections.push(express)\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].selectionAdd);\r\n  }\r\n\r\n  handleJoinSelectionsPartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinSelectionsPartEvent\", joinIndex, expIndex);\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      // this.removePart(this.target.joinQueryList[joinIndex].selections, part);\r\n      this.target.joinQueryList[joinIndex].selections.splice(expIndex, 1);\r\n      this.updateRestSql()\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    }\r\n  }\r\n\r\n  addWhereAction(part, index) {\r\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\r\n\r\n    this.target.whereParts.push(express);\r\n\r\n    this.resetPlusButton(this.whereAdd);\r\n  }\r\n\r\n  handleWherePartEvent(part, index, event) {\r\n    // console.log(\"handleWherePartEvent\", event);\r\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\r\n      // 暂时只支持展开操作符列表\r\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\r\n    } else if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.whereParts.splice(index, 1);\r\n      this.updateRestSql()\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addJoinWhereAction(joinIndex, expIndex) {\r\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\r\n    console.log(\"addWhereAction\", express);\r\n    this.target.joinQueryList[joinIndex].where.push(express);\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].whereAdd);\r\n  }\r\n\r\n  handleJoinWherePartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinWherePartEvent\", event);\r\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\r\n      // 暂时只支持展开操作符列表\r\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\r\n    } else if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.joinQueryList[joinIndex].where.splice(expIndex, 1);\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addAggAction() {\r\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\r\n    console.log(\"addAggAction\", express);\r\n    this.target.aggParts.push(express);\r\n    this.resetPlusButton(this.aggAdd);\r\n  }\r\n\r\n  handleAggPartEvent(part, index, event) {\r\n    console.log(\"handleAggPartEvent\", event, part, index);\r\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\r\n      // 暂时只支持展开操作符列表\r\n      const operators = event.param.options;\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\r\n    } else if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.aggParts.splice(index, 1)\r\n      this.updateRestSql()\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addJoinAggAction(joinIndex) {\r\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\r\n    console.log(\"addJoinAggAction\", express);\r\n    this.target.joinQueryList[joinIndex].aggs.push(express);\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].aggAdd);\r\n  }\r\n\r\n  handleJoinAggPartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinAggPartEvent\", event);\r\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\r\n      // 暂时只支持展开操作符列表\r\n      const operators = event.param.options;\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\r\n    } else if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.joinQueryList[joinIndex].aggs.splice(expIndex, 1);\r\n      this.updateRestSql()\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addGroupAction() {\r\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\r\n    console.log(\"addGroupsAction\", express);\r\n    this.target.groupParts.push(express);\r\n    this.resetPlusButton(this.groupAdd);\r\n  }\r\n\r\n  handleGroupPartEvent(part, index, event) {\r\n    console.log(\"handleGroupsPartEvent\");\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.groupParts.splice(index, 1);\r\n      this.updateRestSql()\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    }\r\n  }\r\n\r\n  addJoinGroupAction(part, joinIndex, expIndex) {\r\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\r\n    console.log(\"addGroupsAction\", express);\r\n    this.target.joinQueryList[joinIndex].groups.push(express);\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].groupAdd);\r\n  }\r\n\r\n  handleJoinGroupPartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinGroupPartEvent\");\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.joinQueryList[joinIndex].groups.splice(expIndex, 1);\r\n      this.updateRestSql();\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    }\r\n  }\r\n\r\n  addJoinOnAction(part, joinIndex, expIndex) {\r\n    const express = sqlPart.create({ type: 'on', params: ['field', 'field'] });\r\n    console.log(\"addJoinOnAction\", express);\r\n    this.target.joinQueryList[joinIndex].on.push(express);\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].onAdd);\r\n  }\r\n\r\n  handleJoinOnPartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinOnPartEvent\", event);\r\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\r\n      // 暂时只支持展开操作符列表\r\n      const operators = ['='];\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\r\n    } else if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.joinQueryList[joinIndex].on.splice(expIndex, 1);\r\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field1\") {\r\n      // on field1=field2，field1是join的表中的字段，field2是原始表中的字段，这里做成可选项\r\n      console.log(\"handleJoinOnPartEvent\", this.target.joinQueryList[joinIndex]);\r\n      const options = [];\r\n      this.target.joinQueryList[joinIndex].selections.forEach((part) => {\r\n        options.push(part[\"params\"][0]);\r\n      });\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\r\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field2\") {\r\n      const options = [];\r\n      this.target.selectionsParts.forEach((part) => {\r\n        options.push(part[\"params\"][0]);\r\n      });\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addJoinExportAction(part, joinIndex, expIndex) {\r\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\r\n    console.log(\"addJoinOnAction\", express);\r\n    this.target.joinQueryList[joinIndex].export.push(express);\r\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].exportAdd);\r\n  }\r\n\r\n  handleJoinExportPartEvent(part, joinIndex, expIndex, event) {\r\n    console.log(\"handleJoinExportPartEvent\", event);\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      this.target.joinQueryList[joinIndex].export.splice(expIndex, 1);\r\n      this.updateRestSql();\r\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\r\n      const options = this.getExportOptions(this.target.joinQueryList[joinIndex].selections, this.target.joinQueryList[joinIndex].aggs);\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addSortAction(index) {\r\n    const express = sqlPart.create({ type: 'sort', params: ['asc', 'field'] });\r\n    console.log(\"addSortAction\", index);\r\n    this.target.sortParts.push(express);\r\n    this.resetPlusButton(this.sortAdd);\r\n  }\r\n\r\n  handleSortPartEvent(part, index, event) {\r\n    console.log(\"handleSortPartEvent\", event);\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n      // console.log(this.target.sortParts,'====');\r\n\r\n      this.target.sortParts.splice(index, 1);\r\n      this.updateRestSql();\r\n      // console.log(this.target.sortParts,'====');\r\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  addFieldAction(index) {\r\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\r\n    console.log(\"addSortAction\", index, express);\r\n    this.target.fieldParts.push(express);\r\n    this.resetPlusButton(this.fieldAdd);\r\n  }\r\n\r\n  handleFieldPartEvent(part, index, event) {\r\n    // console.log(\"handleFieldPartEvent\", event);\r\n    if (event.name === \"get-part-actions\") {\r\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\r\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\r\n\r\n      this.target.fieldParts.splice(index, 1);\r\n      this.updateRestSql();\r\n\r\n    } else if (event.name === \"get-param-options\") {\r\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\r\n    } else if (event.name === \"part-param-changed\") {\r\n      this.updateRestSql();\r\n    } else {\r\n      return Promise.resolve([]);\r\n    }\r\n  }\r\n\r\n  resetPlusButton(button) {\r\n    const plusButton = this.uiSegmentSrv.newPlusButton();\r\n    button.html = plusButton.html;\r\n    button.value = plusButton.value;\r\n  }\r\n\r\n  addJoin() {\r\n    const queryObj = {\r\n      type: \"left_join\",\r\n      table: this.uiSegmentSrv.newSegment({ \"value\": \"select table\", \"fake\": true }),\r\n      selections: [],\r\n      selectionAdd: this.uiSegmentSrv.newPlusButton(),\r\n      where: [],\r\n      whereAdd: this.uiSegmentSrv.newPlusButton(),\r\n      aggs: [],\r\n      aggAdd: this.uiSegmentSrv.newPlusButton(),\r\n      groups: [],\r\n      groupAdd: this.uiSegmentSrv.newPlusButton(),\r\n      on: [],\r\n      onAdd: this.uiSegmentSrv.newPlusButton(),\r\n      export: [],\r\n      exportAdd: this.uiSegmentSrv.newPlusButton()\r\n    };\r\n    this.target.joinQueryList.push(queryObj);\r\n    console.log(\"addJoin\", this.target.joinQueryList);\r\n  }\r\n  delJoin(index) {\r\n    this.target.joinQueryList.splice(index, 1)\r\n  }\r\n\r\n  getAllFields() {\r\n    // 获取select的字段，aggregate的字段，以及所有join表中的export字段\r\n\r\n    const mainFields = this.getExportOptions(this.target.selectionsParts, this.target.aggParts);\r\n    const exportFields = []\r\n    this.target.joinQueryList.forEach((query) => {\r\n      console.log(\"fafadsf1\", query.export)\r\n      query.export.forEach((part) => {\r\n        console.log(\"fafadsf2\", part);\r\n        exportFields.push(part.params[1]) // todo: 重复元素保护\r\n      });\r\n    });\r\n    return mainFields.concat(exportFields)\r\n  }\r\n\r\n  getExportOptions(selections, aggs) {\r\n    // 获取select的字段和aggs的字段并格式化为restSql格式\r\n    const options = [];\r\n    selections.forEach((part) => {\r\n      // export已经select的字段\r\n      options.push(part[\"params\"][0]);\r\n    });\r\n    aggs.forEach((part) => {\r\n      // export已经aggregation的字段\r\n      console.log(\"handleJoinExportPartEvent\", part);\r\n      const [aggFunc, field] = part.params;\r\n      options.push([field, aggFunc].join(\"__\"));\r\n    });\r\n    return options;\r\n  }\r\n\r\n  updateRestSql() {\r\n    // 将输入的内容更新到target中去\r\n\r\n    this.target.query = {\r\n      // restSql协议结构定义\r\n      \"select\": {\r\n        \"from\": \"\",\r\n        \"fields\": [],\r\n        \"filter\": {},\r\n        \"group_by\": [],\r\n        \"aggregation\": [],\r\n        \"sort\": [],\r\n      },\r\n      \"join\": [],\r\n      \"sort\": [],\r\n      \"fields\": [],\r\n      \"limit\": 200\r\n    };\r\n\r\n    // udpate table\r\n    this.target.query.select.from = this.target.table;\r\n\r\n    // update select fields\r\n    this.target.selectionsParts.forEach((part) => {\r\n      this.target.query.select.fields.push(part.params[0]);\r\n    });\r\n\r\n    // update where\r\n    const operatorToSuffix = {\r\n      \"=\": \"\",\r\n      \"<\": \"__lt\",\r\n      \"<=\": \"__lte\",\r\n      \">\": \"__gt\",\r\n      \">=\": \"__gte\",\r\n      \"CONTAINS\": \"__contains\",\r\n      \"STARTSWITH\": \"__startswith\",\r\n      \"ENDSWITH\": \"__endswith\",\r\n      \"RANGE\": \"__range\",\r\n      \"IN\": \"__in\"\r\n    }\r\n    // [\"1\", \"=\", \"1\"]\r\n    this.target.whereParts.forEach((part) => {\r\n\r\n      const suffix = operatorToSuffix[part.params[1]];\r\n      const key = `${part.params[0]}${suffix}`\r\n      if (part.params[1] === \"IN\") {\r\n        console.log(\"whereTest\", part.params[2], typeof part.params[2]);\r\n        this.target.query.select.filter[key] = JSON.parse(part.params[2]);\r\n\r\n      } else {\r\n        if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\r\n          const tmpStr = part.params[2]\r\n          this.target.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\r\n          // console.log(this.target.query.select);\r\n        } else if (!isNaN(parseFloat(part.params[2]))) {\r\n          this.target.query.select.filter[key] = parseFloat(part.params[2]);\r\n          console.log(this.target.query.select);\r\n        }\r\n        else if (part.params[2].toLowerCase() === \"true\") {\r\n          this.target.query.select.filter[key] = true;\r\n        } else if (part.params[2].toLowerCase() === \"false\") {\r\n          this.target.query.select.filter[key] = false;\r\n        }\r\n        else {\r\n          return Promise.reject({\r\n            message: 'tetete',\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    // update aggregation\r\n    // todo:agg func无法修改, 无法删除\r\n    this.target.aggParts.forEach((part) => {\r\n      console.log(\"aggParts\", part);\r\n      const [aggFunc, field] = part.params;\r\n      this.target.query.select.aggregation.push([field, aggFunc].join(\"__\"));\r\n    });\r\n\r\n    // update group by\r\n    this.target.groupParts.forEach((part) => {\r\n      console.log(\"groupParts\", part);\r\n      this.target.query.select.group_by.push(part.params[0]);\r\n    });\r\n\r\n    // update join\r\n    this.target.joinQueryList.forEach((query) => {\r\n      console.log(\"joinQueryList\", query);\r\n      const joinQuery = {};\r\n      // update join type\r\n      joinQuery.type = query.type;\r\n      joinQuery.query = { \"select\": {} };\r\n      console.log(\"joinQueryList\", query);\r\n      // update join table\r\n      joinQuery.query.select.from = query.table.value;\r\n      console.log(\"joinQueryList\", joinQuery.query.select.from);\r\n      // update join fields\r\n      joinQuery.query.select.fields = []\r\n      query.selections.forEach((part) => {\r\n        console.log(\"selections\", part);\r\n        joinQuery.query.select.fields.push(part.params[0]);\r\n      });\r\n      // udpate join filter\r\n      joinQuery.query.select.filter = {};\r\n      query.where.forEach((part) => {\r\n        const suffix = operatorToSuffix[part.params[1]];\r\n        const key = `${part.params[0]}${suffix}`;\r\n\r\n        if (part.params[1] === \"IN\") {\r\n          console.log(\"whereTest\", part.params[2], typeof part.params[2]);\r\n          joinQuery.query.select.filter[key] = JSON.parse(part.params[2]);\r\n        } else {\r\n          console.log(\"whereTest\", part.params[2]);\r\n          if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\r\n            const tmpStr = part.params[2]\r\n            joinQuery.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\r\n          } else if (!isNaN(parseFloat(part.params[2]))) {\r\n            joinQuery.query.select.filter[key] = parseFloat(part.params[2]);\r\n          } else {\r\n            return Promise.reject({\r\n              message: 'tetete',\r\n            });\r\n          }\r\n\r\n        }\r\n\r\n        console.log(\"joinfilter\", key, joinQuery.query.select.filter);\r\n      })\r\n      // update aggregation \r\n      // todo:agg func无法修改\r\n      joinQuery.query.select.aggregation = [];\r\n      query.aggs.forEach((part) => {\r\n        console.log(\"join_aggregation\", part);\r\n        const [aggFunc, field] = part.params;\r\n        joinQuery.query.select.aggregation.push([field, aggFunc].join(\"__\"));\r\n      });\r\n      // update join group by\r\n      joinQuery.query.select.group_by = [];\r\n      query.groups.forEach((part) => {\r\n        // console.log(\"join_group\", part);\r\n        joinQuery.query.select.group_by.push(part.params[0]);\r\n      });\r\n      // update join on\r\n      joinQuery.on = {};\r\n      query.on.forEach((part) => {\r\n        joinQuery.on[part.params[0]] = part.params[1];\r\n      });\r\n      // updaate export\r\n      joinQuery.export = [];\r\n      query.export.forEach((part) => {\r\n        console.log(\"joinQuery\");\r\n        joinQuery.export.push(part.params.join(\"@\"));\r\n      });\r\n      this.target.query.join.push(joinQuery);\r\n    });\r\n\r\n    // update sort\r\n    this.target.sortParts.forEach((part) => {\r\n      console.log(\"sortParts\", part);\r\n      const sortExp = part.params[0] === \"asc\" ? part.params[1] : `-${part.params[1]}`;\r\n      this.target.query.sort.push(sortExp);\r\n    });\r\n\r\n    //update fields\r\n    this.target.fieldParts.forEach((part) => {\r\n      console.log(\"fieldParts\", part.params[0],'5555555555');\r\n      this.target.query.fields.push(part.params.join(\"@\"));\r\n    });\r\n\r\n    // update limit\r\n    this.target.query.limit = parseInt(this.target.limit);\r\n    // console.log(\"UpdateComplete\", this.target.query);\r\n    // this.datasource.metricFindQuery(this.target.query || '').then(this.panelCtrl.refresh());\r\n    // console.log(this.target, this.target.query);\r\n    this.target.target = JSON.stringify(this.target.query);\r\n    // this.target.target = this.target.query;\r\n\r\n    // console.log(this.target, this.target.query);\r\n    this.target.whereParts = this.target.whereParts;\r\n    // console.log(\"UpdateComplete\", this.target.selectionsParts);\r\n    // this.datasource.metricFindQuery(JSON.stringify(this.target.query) || '');\r\n    // this.datasource.query(this.target.query);\r\n    this.panelCtrl.refresh();\r\n\r\n  }\r\n}\r\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\r\n\r\n"]}