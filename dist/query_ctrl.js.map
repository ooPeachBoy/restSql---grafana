{"version":3,"sources":["../src/query_ctrl.js"],"names":["GenericDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","formats","text","value","types","target","type","tableSegment","newSegment","table","selectionsParts","selectionAdd","newPlusButton","selectMenu","push","whereParts","whereAdd","aggParts","aggAdd","groupParts","groupAdd","joinQueryList","sortParts","sortAdd","fieldParts","fieldAdd","limitSegment","limit","query","options","console","log","Promise","resolve","parts","part","index","_","indexOf","splice","updateRestSql","joinIndex","getOptions","express","sqlPart","create","params","resetPlusButton","event","name","action","removePart","forEach","item","i","expIndex","selections","param","operators","newOperators","where","aggs","groups","on","onAdd","export","exportAdd","getExportOptions","getAllFields","button","plusButton","html","queryObj","mainFields","exportFields","concat","aggFunc","field","join","select","from","fields","operatorToSuffix","suffix","key","filter","JSON","parse","startsWith","endsWith","tmpStr","slice","length","isNaN","parseFloat","toLowerCase","reject","message","aggregation","group_by","joinQuery","sortExp","sort","parseInt","stringify","panelCtrl","refresh","QueryCtrl","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import './css/query-editor.css!'\n\nimport _ from 'lodash';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport sqlPart from './sql_part';\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n    // console.log(\"GenericDatasourceQueryCtrl\", uiSegmentSrv);\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv\n\n\n    this.formats = [\n      { text: 'Time series', value: 'grafana.timeserie' },\n      { text: 'Table', value: 'grafana.table' },\n    ];\n    this.types = [\n      { text: 'Left Join', value: 'left_join' },\n      { text: 'Inner Join', value: 'inner_join' },\n      { text: 'Full Join', value: 'full_join' }\n    ];\n    \n\n    // this.target.tableSegment = null;\n    this.target.target = this.target.target || 'targettest';\n    this.target.type = this.target.type;\n\n    this.target.tableSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.table||'select table', \"fake\": true });\n    this.target.table = this.target.table || this.target.tableSegment.value;\n    this.target.selectionsParts = this.target.selectionsParts|| [];\n    this.selectionAdd = this.uiSegmentSrv.newPlusButton();  \n    \n    this.selectMenu = [];\n    this.selectMenu .push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n   \n    this.target.whereParts = this.target.whereParts|| [];\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.aggParts = this.target.aggParts|| [];\n    this.aggAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.groupParts = this.target.groupParts|| [];\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.joinQueryList = this.target.joinQueryList|| [];\n\n    this.target.sortParts = this.target.sortParts|| [];\n    this.sortAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.fieldParts = this.target.fieldParts|| [];\n    this.fieldAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.limitSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.limit||'1000', \"fake\": true });\n    this.target.limit = this.target.limitSegment.value||'1000';\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"filter\": {},\n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n  }\n \n  getOptions() {\n    const options = [];\n    options.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n    console.log(\"tttttt getOptions\", options);\n    return Promise.resolve(options);\n  }  \n\n  removePart(parts, part) {\n    const index = _.indexOf(parts, part);\n    parts.splice(index, 1);\n  }\n\n  onFormatChanged() {\n    console.log(\"onFormatChanged\", this);\n    this.updateRestSql();\n  }\n\n  onTableChanged() {\n    console.log(\"tableChanged\", this);\n    this.target.table = this.target.tableSegment.value;\n    this.updateRestSql();\n  }\n\n  onJoinTableChanged(joinIndex) {\n    console.log(\"onJoinTableChanged\", joinIndex);\n    // this.target.joinQueryList[joinIndex].table = ;\n    this.updateRestSql();\n  }\n\n  onLimitChanged() {\n    // console.log(\"onLimitChanged\");\n    this.target.limit = this.target.limitSegment.value;\n    this.updateRestSql();\n  }\n\n  addSelectionAction(part, index) {\n    console.log(1111, part,index);\n    this.getOptions()\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.selectionsParts.push(express);\n    this.resetPlusButton(this.selectionAdd);\n\n  }\n\n  handleSelectionsPartEvent(part, index, event) {\n    console.log(\"tttttt handleSelectionsPartEvent\", event, index, part, '---');\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.removePart(this.target.selectionsParts, part);\n      // this.target.selectionsParts.splice(index, 1, null);\n      this.updateRestSql()\n      console.log(this.target.selectionsParts, '------')\n    } else if (event.name === \"part-param-changed\") {\n      console.log(this.target.selectionsParts);\n      this.target.selectionsParts.forEach((item, i) => {\n      })\n      this.updateRestSql();\n    }\n  }\n\n  addJoinSelectionAction(joinIndex, expIndex) {\n    console.log(\"addJoinSelectionAction\", joinIndex, expIndex);\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.joinQueryList[joinIndex].selections.push(express)\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].selectionAdd);\n  }\n\n  handleJoinSelectionsPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinSelectionsPartEvent\", joinIndex, expIndex);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // this.removePart(this.target.joinQueryList[joinIndex].selections, part);\n      this.target.joinQueryList[joinIndex].selections.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addWhereAction(part, index) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n\n    this.target.whereParts.push(express);\n  \n    this.resetPlusButton(this.whereAdd);\n  }\n\n  handleWherePartEvent(part, index, event) {\n    // console.log(\"handleWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.whereParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinWhereAction(joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n    console.log(\"addWhereAction\", express);\n    this.target.joinQueryList[joinIndex].where.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].whereAdd);\n  }\n\n  handleJoinWherePartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].where.splice(expIndex, 1);\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addAggAction() {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addAggAction\", express);\n    this.target.aggParts.push(express);\n    this.resetPlusButton(this.aggAdd);\n  }\n\n  handleAggPartEvent(part, index, event) {\n    console.log(\"handleAggPartEvent\");\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.aggParts.splice(index, 1)\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinAggAction(joinIndex) {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addJoinAggAction\", express);\n    this.target.joinQueryList[joinIndex].aggs.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].aggAdd);\n  }\n\n  handleJoinAggPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinAggPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].aggs.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addGroupAction() {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.groupParts.push(express);\n    this.resetPlusButton(this.groupAdd);\n  }\n\n  handleGroupPartEvent(part, index, event) {\n    console.log(\"handleGroupsPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.groupParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinGroupAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.joinQueryList[joinIndex].groups.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].groupAdd);\n  }\n\n  handleJoinGroupPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinGroupPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].groups.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinOnAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'on', params: ['field', 'field'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].on.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].onAdd);\n  }\n\n  handleJoinOnPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinOnPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['='];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].on.splice(expIndex, 1);\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field1\") {\n      // on field1=field2，field1是join的表中的字段，field2是原始表中的字段，这里做成可选项\n      console.log(\"handleJoinOnPartEvent\", this.target.joinQueryList[joinIndex]);\n      const options = [];\n      this.target.joinQueryList[joinIndex].selections.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field2\") {\n      const options = [];\n      this.target.selectionsParts.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinExportAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].export.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].exportAdd);\n  }\n\n  handleJoinExportPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinExportPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].export.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      const options = this.getExportOptions(this.target.joinQueryList[joinIndex].selections, this.target.joinQueryList[joinIndex].aggs);\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addSortAction(index) {\n    const express = sqlPart.create({ type: 'sort', params: ['asc', 'field'] });\n    console.log(\"addSortAction\", index);\n    this.target.sortParts.push(express);\n    this.resetPlusButton(this.sortAdd);\n  }\n\n  handleSortPartEvent(part, index, event) {\n    console.log(\"handleSortPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // console.log(this.target.sortParts,'====');\n\n      this.target.sortParts.splice(index, 1);\n      this.updateRestSql();\n      // console.log(this.target.sortParts,'====');\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addFieldAction(index) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addSortAction\", index);\n    this.target.fieldParts.push(express);\n    this.resetPlusButton(this.fieldAdd);\n  }\n\n  handleFieldPartEvent(part, index, event) {\n    console.log(\"handleFieldPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n\n      this.target.fieldParts.splice(index, 1);\n      this.updateRestSql();\n\n    } else if (event.name === \"get-param-options\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  resetPlusButton(button) {\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    button.html = plusButton.html;\n    button.value = plusButton.value;\n  }\n\n  addJoin() {\n    const queryObj = {\n      type: \"left_join\",\n      table: this.uiSegmentSrv.newSegment({ \"value\": \"select table\", \"fake\": true }),\n      selections: [],\n      selectionAdd: this.uiSegmentSrv.newPlusButton(),\n      where: [],\n      whereAdd: this.uiSegmentSrv.newPlusButton(),\n      aggs: [],\n      aggAdd: this.uiSegmentSrv.newPlusButton(),\n      groups: [],\n      groupAdd: this.uiSegmentSrv.newPlusButton(),\n      on: [],\n      onAdd: this.uiSegmentSrv.newPlusButton(),\n      export: [],\n      exportAdd: this.uiSegmentSrv.newPlusButton()\n    };\n    this.target.joinQueryList.push(queryObj);\n    console.log(\"addJoin\", this.target.joinQueryList);\n  }\n  delJoin(index) {\n    this.target.joinQueryList.splice(index, 1)\n  }\n\n  getAllFields() {\n    // 获取select的字段，aggregate的字段，以及所有join表中的export字段\n\n    const mainFields = this.getExportOptions(this.target.selectionsParts, this.target.aggParts);\n    console.log(this.target.selectionsParts, '--------');\n    const exportFields = []\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"fafadsf1\", query.export)\n      query.export.forEach((part) => {\n        console.log(\"fafadsf2\", part);\n        exportFields.push(part.params[1]) // todo: 重复元素保护\n      });\n    });\n    return mainFields.concat(exportFields)\n  }\n\n  getExportOptions(selections, aggs) {\n    // 获取select的字段和aggs的字段并格式化为restSql格式\n    const options = [];\n    selections.forEach((part) => {\n      // export已经select的字段\n      options.push(part[\"params\"][0]);\n    });\n    aggs.forEach((part) => {\n      // export已经aggregation的字段\n      console.log(\"handleJoinExportPartEvent\", part);\n      const [aggFunc, field] = part.params;\n      options.push([field, aggFunc].join(\"__\"));\n    });\n    return options;\n  }\n\n  updateRestSql() {\n    // 将输入的内容更新到target中去\n\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"fields\": [],\n        \"filter\":{}, \n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n    // udpate table\n    this.target.query.select.from = this.target.table;\n\n    // update select fields\n    this.target.selectionsParts.forEach((part) => {\n      this.target.query.select.fields.push(part.params[0]);\n    });\n\n    // update where\n    const operatorToSuffix = {\n      \"=\": \"\",\n      \"<\": \"__lt\",\n      \"<=\": \"__lte\",\n      \">\": \"__gt\",\n      \">=\": \"__gte\",\n      \"CONTAINS\": \"__contains\",\n      \"STARTSWITH\": \"__startswith\",\n      \"ENDSWITH\": \"__endswith\",\n      \"RANGE\": \"__range\",\n      \"IN\": \"__in\"\n    }\n    // [\"1\", \"=\", \"1\"]\n    this.target.whereParts.forEach((part) => {\n\n      const suffix = operatorToSuffix[part.params[1]];\n      const key = `${part.params[0]}${suffix}`\n      if (part.params[1] === \"IN\") {\n        console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n        this.target.query.select.filter[key] = JSON.parse(part.params[2]);\n       \n      } else {\n        if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n          const tmpStr = part.params[2]\n          this.target.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          // console.log(this.target.query.select);\n        } else if (!isNaN(parseFloat(part.params[2]))) {\n          this.target.query.select.filter[key] = parseFloat(part.params[2]);\n          console.log(this.target.query.select);\n        }\n        else if (part.params[2].toLowerCase() === \"true\" ) {          \n          this.target.query.select.filter[key] =true;\n        } else if (part.params[2].toLowerCase() === \"false\") {\n          this.target.query.select.filter[key] = false;\n        }\n        else {\n          return Promise.reject({\n            message: 'tetete',\n          });\n        }\n      }\n    });\n\n    // update aggregation\n    // todo:agg func无法修改, 无法删除\n    this.target.aggParts.forEach((part) => {\n      console.log(\"aggParts\", part);\n      const [aggFunc, field] = part.params;\n      this.target.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n    });\n\n    // update group by\n    this.target.groupParts.forEach((part) => {\n      console.log(\"groupParts\", part);\n      this.target.query.select.group_by.push(part.params[0]);\n    });\n\n    // update join\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"joinQueryList\", query);\n      const joinQuery = {};\n      // update join type\n      joinQuery.type = query.type;\n      joinQuery.query = { \"select\": {} };\n      console.log(\"joinQueryList\", query);\n      // update join table\n      joinQuery.query.select.from = query.table.value;\n      console.log(\"joinQueryList\", joinQuery.query.select.from);\n      // update join fields\n      joinQuery.query.select.fields = []\n      query.selections.forEach((part) => {\n        console.log(\"selections\", part);\n        joinQuery.query.select.fields.push(part.params[0]);\n      });\n      // udpate join filter\n      joinQuery.query.select.filter = {};\n      query.where.forEach((part) => {\n        const suffix = operatorToSuffix[part.params[1]];\n        const key = `${part.params[0]}${suffix}`;\n\n        if (part.params[1] === \"IN\") {\n          console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n          joinQuery.query.select.filter[key] = JSON.parse(part.params[2]);\n        } else {\n          console.log(\"whereTest\", part.params[2]);\n          if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n            const tmpStr = part.params[2]\n            joinQuery.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          } else if (!isNaN(parseFloat(part.params[2]))) {\n            joinQuery.query.select.filter[key] = parseFloat(part.params[2]);\n          } else {\n            return Promise.reject({\n              message: 'tetete',\n            });\n          }\n\n        }\n\n        console.log(\"joinfilter\", key, joinQuery.query.select.filter);\n      })\n      // update aggregation \n      // todo:agg func无法修改\n      joinQuery.query.select.aggregation = [];\n      query.aggs.forEach((part) => {\n        console.log(\"join_aggregation\", part);\n        const [aggFunc, field] = part.params;\n        joinQuery.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n      });\n      // update join group by\n      joinQuery.query.select.group_by = [];\n      query.groups.forEach((part) => {\n        // console.log(\"join_group\", part);\n        joinQuery.query.select.group_by.push(part.params[0]);\n      });\n      // update join on\n      joinQuery.on = {};\n      query.on.forEach((part) => {\n        joinQuery.on[part.params[0]] = part.params[1];\n      });\n      // updaate export\n      joinQuery.export = [];\n      query.export.forEach((part) => {\n        console.log(\"joinQuery\");\n        joinQuery.export.push(part.params.join(\"@\"));\n      });\n      this.target.query.join.push(joinQuery);\n    });\n\n    // update sort\n    this.target.sortParts.forEach((part) => {\n      console.log(\"sortParts\", part);\n      const sortExp = part.params[0] === \"asc\" ? part.params[1] : `-${part.params[1]}`;\n      this.target.query.sort.push(sortExp);\n    });\n\n    //update fields\n    this.target.fieldParts.forEach((part) => {\n      // console.log(\"fieldParts\", part);\n      this.target.query.fields.push(part.params.join(\"@\"));\n    });\n\n    // update limit\n    this.target.query.limit = parseInt(this.target.limit);\n    // console.log(\"UpdateComplete\", this.target.query);\n    // this.datasource.metricFindQuery(this.target.query || '').then(this.panelCtrl.refresh());\n    // console.log(this.target, this.target.query);\n    this.target.target = JSON.stringify(this.target.query);\n    // this.target.target = this.target.query;\n\n    // console.log(this.target, this.target.query);\n    this.target.whereParts = this.target.whereParts;\n    // console.log(\"UpdateComplete\", this.target.selectionsParts);\n    // this.datasource.metricFindQuery(JSON.stringify(this.target.query) || '');\n    // this.datasource.query(this.target.query);\n    this.panelCtrl.refresh();\n\n  }\n}\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}