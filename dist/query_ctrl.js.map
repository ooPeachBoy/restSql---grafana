{"version":3,"sources":["../src/query_ctrl.js"],"names":["GenericDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","console","log","scope","formats","text","value","types","selectMenu","buildSelectMenu","target","type","tableSegment","newSegment","table","selectionsParts","selectionAdd","newPlusButton","whereParts","whereAdd","aggParts","aggAdd","groupParts","groupAdd","joinQueryList","sortParts","sortAdd","fieldParts","fieldAdd","limitSegment","limit","query","select","push","options","Promise","resolve","selectParts","$item","$subItem","parts","part","index","_","indexOf","splice","updateRestSql","joinIndex","getOptions","express","sqlPart","create","params","resetPlusButton","event","name","action","removePart","forEach","item","i","expIndex","selections","param","operators","newOperators","where","aggs","groups","on","onAdd","export","exportAdd","getExportOptions","getAllFields","button","plusButton","html","queryObj","mainFields","exportFields","concat","aggFunc","field","join","from","fields","operatorToSuffix","suffix","key","filter","JSON","parse","startsWith","endsWith","tmpStr","slice","length","isNaN","parseFloat","reject","message","aggregation","group_by","joinQuery","sortExp","sort","parseInt","stringify","panelCtrl","refresh","QueryCtrl","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import './css/query-editor.css!'\n\nimport _ from 'lodash';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport sqlPart from './sql_part';\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n    console.log(\"GenericDatasourceQueryCtrl\", uiSegmentSrv);\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv\n\n\n    this.formats = [\n      { text: 'Time series', value: 'grafana.timeserie' },\n      { text: 'Table', value: 'grafana.table' },\n    ];\n    this.types = [\n      { text: 'Left Join', value: 'left_join' },\n      { text: 'Inner Join', value: 'inner_join' },\n      { text: 'Full Join', value: 'full_join' }\n    ];\n    this.selectMenu = []\n    this.buildSelectMenu()\n\n    // this.target.tableSegment = null;\n    this.target.target = this.target.target || 'targettest';\n    this.target.type = this.target.type;\n\n    this.target.tableSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.table||'select table', \"fake\": true });\n    this.target.table = this.target.table || this.target.tableSegment.value;\n    this.target.selectionsParts = this.target.selectionsParts|| [];\n    this.selectionAdd = this.uiSegmentSrv.newPlusButton();    \n\n    this.target.whereParts = this.target.whereParts|| [];\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.aggParts = this.target.aggParts|| [];\n    this.aggAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.groupParts = this.target.groupParts|| [];\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.joinQueryList = this.target.joinQueryList|| [];\n\n    this.target.sortParts = this.target.sortParts|| [];\n    this.sortAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.fieldParts = this.target.fieldParts|| [];\n    this.fieldAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.limitSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.limit||'1000', \"fake\": true });\n    this.target.limit = this.target.limitSegment.value||'1000';\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"filter\": {},\n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n  }\n  buildSelectMenu() {\n    this.selectMenu = [];\n    const select = {\n      text: 'expression',\n      value: 'Expression',\n    }\n    this.selectMenu.push(select);\n  }\n  getOptions() {\n    const options = [];\n    options.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n    console.log(\"tttttt getOptions\", options);\n    return Promise.resolve(options);\n  }\n  addSelectPart(selectParts, $item, $subItem) {\n    console.log(selectParts, $item, $subItem,'0000');\n  }\n\n  removePart(parts, part) {\n    const index = _.indexOf(parts, part);\n    parts.splice(index, 1);\n  }\n\n  onFormatChanged() {\n    console.log(\"onFormatChanged\", this);\n    this.updateRestSql();\n  }\n\n  onTableChanged() {\n    console.log(\"tableChanged\", this);\n    this.target.table = this.target.tableSegment.value;\n    this.updateRestSql();\n  }\n\n  onJoinTableChanged(joinIndex) {\n    console.log(\"onJoinTableChanged\", joinIndex);\n    // this.target.joinQueryList[joinIndex].table = ;\n    this.updateRestSql();\n  }\n\n  onLimitChanged() {\n    console.log(\"onLimitChanged\");\n    this.target.limit = this.target.limitSegment.value;\n    this.updateRestSql();\n  }\n\n  addSelectionAction(part, index) {\n    console.log(1111, part,index);\n    this.getOptions()\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.selectionsParts.push(express);\n    this.resetPlusButton(this.selectionAdd);\n\n  }\n\n  handleSelectionsPartEvent(part, index, event) {\n    console.log(\"tttttt handleSelectionsPartEvent\", event, index, part, '---');\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.removePart(this.target.selectionsParts, part);\n      // this.target.selectionsParts.splice(index, 1, null);\n      this.updateRestSql()\n      console.log(this.target.selectionsParts, '------')\n    } else if (event.name === \"part-param-changed\") {\n      console.log(this.target.selectionsParts);\n      this.target.selectionsParts.forEach((item, i) => {\n      })\n      this.updateRestSql();\n    }\n  }\n\n  addJoinSelectionAction(joinIndex, expIndex) {\n    console.log(\"addJoinSelectionAction\", joinIndex, expIndex);\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.joinQueryList[joinIndex].selections.push(express)\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].selectionAdd);\n  }\n\n  handleJoinSelectionsPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinSelectionsPartEvent\", joinIndex, expIndex);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // this.removePart(this.target.joinQueryList[joinIndex].selections, part);\n      this.target.joinQueryList[joinIndex].selections.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addWhereAction(part, index) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n    // console.log(\"addWhereAction\", express);\n    this.target.whereParts.push(express);\n  \n    this.resetPlusButton(this.whereAdd);\n  }\n\n  handleWherePartEvent(part, index, event) {\n    console.log(\"handleWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.whereParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinWhereAction(joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n    console.log(\"addWhereAction\", express);\n    this.target.joinQueryList[joinIndex].where.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].whereAdd);\n  }\n\n  handleJoinWherePartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].where.splice(expIndex, 1);\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addAggAction() {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addAggAction\", express);\n    this.target.aggParts.push(express);\n    this.resetPlusButton(this.aggAdd);\n  }\n\n  handleAggPartEvent(part, index, event) {\n    console.log(\"handleAggPartEvent\");\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.aggParts.splice(index, 1)\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinAggAction(joinIndex) {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addJoinAggAction\", express);\n    this.target.joinQueryList[joinIndex].aggs.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].aggAdd);\n  }\n\n  handleJoinAggPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinAggPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].aggs.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addGroupAction() {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.groupParts.push(express);\n    this.resetPlusButton(this.groupAdd);\n  }\n\n  handleGroupPartEvent(part, index, event) {\n    console.log(\"handleGroupsPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.groupParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinGroupAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.joinQueryList[joinIndex].groups.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].groupAdd);\n  }\n\n  handleJoinGroupPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinGroupPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].groups.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinOnAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'on', params: ['field', 'field'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].on.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].onAdd);\n  }\n\n  handleJoinOnPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinOnPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['='];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].on.splice(expIndex, 1);\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field1\") {\n      // on field1=field2，field1是join的表中的字段，field2是原始表中的字段，这里做成可选项\n      console.log(\"handleJoinOnPartEvent\", this.target.joinQueryList[joinIndex]);\n      const options = [];\n      this.target.joinQueryList[joinIndex].selections.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field2\") {\n      const options = [];\n      this.target.selectionsParts.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinExportAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].export.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].exportAdd);\n  }\n\n  handleJoinExportPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinExportPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].export.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      const options = this.getExportOptions(this.target.joinQueryList[joinIndex].selections, this.target.joinQueryList[joinIndex].aggs);\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addSortAction(index) {\n    const express = sqlPart.create({ type: 'sort', params: ['asc', 'field'] });\n    console.log(\"addSortAction\", index);\n    this.target.sortParts.push(express);\n    this.resetPlusButton(this.sortAdd);\n  }\n\n  handleSortPartEvent(part, index, event) {\n    console.log(\"handleSortPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // console.log(this.target.sortParts,'====');\n\n      this.target.sortParts.splice(index, 1);\n      this.updateRestSql();\n      // console.log(this.target.sortParts,'====');\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addFieldAction(index) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addSortAction\", index);\n    this.target.fieldParts.push(express);\n    this.resetPlusButton(this.fieldAdd);\n  }\n\n  handleFieldPartEvent(part, index, event) {\n    console.log(\"handleFieldPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return Promise.resolve([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n\n      this.target.fieldParts.splice(index, 1);\n      this.updateRestSql();\n\n    } else if (event.name === \"get-param-options\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  resetPlusButton(button) {\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    button.html = plusButton.html;\n    button.value = plusButton.value;\n  }\n\n  addJoin() {\n    const queryObj = {\n      type: \"left_join\",\n      table: this.uiSegmentSrv.newSegment({ \"value\": \"select table\", \"fake\": true }),\n      selections: [],\n      selectionAdd: this.uiSegmentSrv.newPlusButton(),\n      where: [],\n      whereAdd: this.uiSegmentSrv.newPlusButton(),\n      aggs: [],\n      aggAdd: this.uiSegmentSrv.newPlusButton(),\n      groups: [],\n      groupAdd: this.uiSegmentSrv.newPlusButton(),\n      on: [],\n      onAdd: this.uiSegmentSrv.newPlusButton(),\n      export: [],\n      exportAdd: this.uiSegmentSrv.newPlusButton()\n    };\n    this.target.joinQueryList.push(queryObj);\n    console.log(\"addJoin\", this.target.joinQueryList);\n  }\n  delJoin(index) {\n    this.target.joinQueryList.splice(index, 1)\n  }\n\n  getAllFields() {\n    // 获取select的字段，aggregate的字段，以及所有join表中的export字段\n\n    const mainFields = this.getExportOptions(this.target.selectionsParts, this.target.aggParts);\n    console.log(this.target.selectionsParts, '--------');\n    const exportFields = []\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"fafadsf1\", query.export)\n      query.export.forEach((part) => {\n        console.log(\"fafadsf2\", part);\n        exportFields.push(part.params[1]) // todo: 重复元素保护\n      });\n    });\n    return mainFields.concat(exportFields)\n  }\n\n  getExportOptions(selections, aggs) {\n    // 获取select的字段和aggs的字段并格式化为restSql格式\n    const options = [];\n    selections.forEach((part) => {\n      // export已经select的字段\n      options.push(part[\"params\"][0]);\n    });\n    aggs.forEach((part) => {\n      // export已经aggregation的字段\n      console.log(\"handleJoinExportPartEvent\", part);\n      const [aggFunc, field] = part.params;\n      options.push([field, aggFunc].join(\"__\"));\n    });\n    return options;\n  }\n\n  updateRestSql() {\n    // 将输入的内容更新到target中去\n\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"fields\": [],\n        \"filter\":{}, \n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n    // udpate table\n    this.target.query.select.from = this.target.table;\n\n    // update select fields\n    this.target.selectionsParts.forEach((part) => {\n      this.target.query.select.fields.push(part.params[0]);\n    });\n\n    // update where\n    const operatorToSuffix = {\n      \"=\": \"\",\n      \"<\": \"__lt\",\n      \"<=\": \"__lte\",\n      \">\": \"__gt\",\n      \">=\": \"__gte\",\n      \"CONTAINS\": \"__contains\",\n      \"STARTSWITH\": \"__startswith\",\n      \"ENDSWITH\": \"__endswith\",\n      \"RANGE\": \"__range\",\n      \"IN\": \"__in\"\n    }\n    // [\"1\", \"=\", \"1\"]\n    this.target.whereParts.forEach((part) => {\n      console.log(this.target.whereParts);\n      const suffix = operatorToSuffix[part.params[1]];\n      const key = `${part.params[0]}${suffix}`\n      if (part.params[1] === \"IN\") {\n        console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n        this.target.query.select.filter[key] = JSON.parse(part.params[2]);\n        console.log(this.target.query.select);\n      } else {\n        console.log(\"whereTest\", part.params[2]);\n        if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n          const tmpStr = part.params[2]\n          this.target.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          console.log(this.target.query.select);\n        } else if (!isNaN(parseFloat(part.params[2]))) {\n          this.target.query.select.filter[key] = parseFloat(part.params[2]);\n          console.log(this.target.query.select);\n        } else {\n          return Promise.reject({\n            message: 'tetete',\n          });\n        }\n      }\n    });\n\n    // update aggregation\n    // todo:agg func无法修改, 无法删除\n    this.target.aggParts.forEach((part) => {\n      console.log(\"aggParts\", part);\n      const [aggFunc, field] = part.params;\n      this.target.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n    });\n\n    // update group by\n    this.target.groupParts.forEach((part) => {\n      console.log(\"groupParts\", part);\n      this.target.query.select.group_by.push(part.params[0]);\n    });\n\n    // update join\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"joinQueryList\", query);\n      const joinQuery = {};\n      // update join type\n      joinQuery.type = query.type;\n      joinQuery.query = { \"select\": {} };\n      console.log(\"joinQueryList\", query);\n      // update join table\n      joinQuery.query.select.from = query.table.value;\n      console.log(\"joinQueryList\", joinQuery.query.select.from);\n      // update join fields\n      joinQuery.query.select.fields = []\n      query.selections.forEach((part) => {\n        console.log(\"selections\", part);\n        joinQuery.query.select.fields.push(part.params[0]);\n      });\n      // udpate join filter\n      joinQuery.query.select.filter = {};\n      query.where.forEach((part) => {\n        const suffix = operatorToSuffix[part.params[1]];\n        const key = `${part.params[0]}${suffix}`;\n\n        if (part.params[1] === \"IN\") {\n          console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n          joinQuery.query.select.filter[key] = JSON.parse(part.params[2]);\n        } else {\n          console.log(\"whereTest\", part.params[2]);\n          if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n            const tmpStr = part.params[2]\n            joinQuery.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          } else if (!isNaN(parseFloat(part.params[2]))) {\n            joinQuery.query.select.filter[key] = parseFloat(part.params[2]);\n          } else {\n            return Promise.reject({\n              message: 'tetete',\n            });\n          }\n\n        }\n\n        console.log(\"joinfilter\", key, joinQuery.query.select.filter);\n      })\n      // update aggregation \n      // todo:agg func无法修改\n      joinQuery.query.select.aggregation = [];\n      query.aggs.forEach((part) => {\n        console.log(\"join_aggregation\", part);\n        const [aggFunc, field] = part.params;\n        joinQuery.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n      });\n      // update join group by\n      joinQuery.query.select.group_by = [];\n      query.groups.forEach((part) => {\n        console.log(\"join_group\", part);\n        joinQuery.query.select.group_by.push(part.params[0]);\n      });\n      // update join on\n      joinQuery.on = {};\n      query.on.forEach((part) => {\n        joinQuery.on[part.params[0]] = part.params[1];\n      });\n      // updaate export\n      joinQuery.export = [];\n      query.export.forEach((part) => {\n        console.log(\"joinQuery\");\n        joinQuery.export.push(part.params.join(\"@\"));\n      });\n      this.target.query.join.push(joinQuery);\n    });\n\n    // update sort\n    this.target.sortParts.forEach((part) => {\n      console.log(\"sortParts\", part);\n      const sortExp = part.params[0] === \"asc\" ? part.params[1] : `-${part.params[1]}`;\n      this.target.query.sort.push(sortExp);\n    });\n\n    //update fields\n    this.target.fieldParts.forEach((part) => {\n      console.log(\"fieldParts\", part);\n      this.target.query.fields.push(part.params.join(\"@\"));\n    });\n\n    // update limit\n    this.target.query.limit = parseInt(this.target.limit);\n    // console.log(\"UpdateComplete\", this.target.query);\n    // this.datasource.metricFindQuery(this.target.query || '').then(this.panelCtrl.refresh());\n    console.log(this.target, this.target.query);\n    this.target.target = JSON.stringify(this.target.query);\n    // this.target.target = this.target.query;\n\n    console.log(this.target, this.target.query);\n    this.target.whereParts = this.target.whereParts;\n    console.log(\"UpdateComplete\", this.target.selectionsParts);\n    // this.datasource.metricFindQuery(JSON.stringify(this.target.query) || '');\n    // this.datasource.query(this.target.query);\n    this.panelCtrl.refresh();\n\n  }\n}\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}