{"version":3,"sources":["../src/query_ctrl.js"],"names":["GenericDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","$q","scope","formats","text","value","types","console","log","target","type","tableSegment","newSegment","table","selectionsParts","selectionAdd","newPlusButton","selectMenu","push","whereParts","whereAdd","aggParts","aggAdd","groupParts","groupAdd","joinQueryList","sortParts","sortAdd","fieldParts","fieldAdd","limitSegment","limit","query","options","Promise","resolve","parts","part","index","_","indexOf","splice","updateRestSql","joinIndex","getOptions","express","sqlPart","create","params","resetPlusButton","event","name","when","action","removePart","forEach","item","i","expIndex","selections","param","operators","newOperators","where","aggs","groups","on","onAdd","export","exportAdd","getExportOptions","getAllFields","button","plusButton","html","queryObj","mainFields","exportFields","concat","aggFunc","field","join","select","from","fields","operatorToSuffix","suffix","key","filter","JSON","parse","startsWith","endsWith","tmpStr","slice","length","isNaN","parseFloat","toLowerCase","reject","message","aggregation","group_by","joinQuery","sortExp","sort","parseInt","stringify","panelCtrl","refresh","QueryCtrl","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import './css/query-editor.css!'\n\nimport _ from 'lodash';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport sqlPart from './sql_part';\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv,$q) {\n    super($scope, $injector);\n    // console.log(\"GenericDatasourceQueryCtrl\", uiSegmentSrv);\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.$q = $q;\n\n\n    this.formats = [\n      { text: 'Time series', value: 'grafana.timeserie' },\n      { text: 'Table', value: 'grafana.table' },\n    ];\n    this.types = [\n      { text: 'Left Join', value: 'left_join' },\n      { text: 'Inner Join', value: 'inner_join' },\n      { text: 'Full Join', value: 'full_join' }\n    ];\n    \n    console.log(this.target, 11111111111111111111);\n  \n    // this.target.tableSegment = null;\n    this.target.target = this.target.target || 'targettest';\n    this.target.type = this.target.type;\n\n    this.target.tableSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.table||'select table', \"fake\": true });\n    this.target.table = this.target.table || this.target.tableSegment.value;\n    this.target.selectionsParts = this.target.selectionsParts|| [];\n    this.selectionAdd = this.uiSegmentSrv.newPlusButton();  \n    \n    this.selectMenu = [];\n    this.selectMenu .push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n   \n    this.target.whereParts = this.target.whereParts|| [];\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.aggParts = this.target.aggParts|| [];\n    this.aggAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.groupParts = this.target.groupParts|| [];\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.joinQueryList = this.target.joinQueryList|| [];\n\n    this.target.sortParts = this.target.sortParts|| [];\n    this.sortAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.fieldParts = this.target.fieldParts|| [];\n    this.fieldAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.target.limitSegment = this.uiSegmentSrv.newSegment({ \"value\": this.target.limit||'1000', \"fake\": true });\n    this.target.limit = this.target.limitSegment.value||'1000';\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"filter\": {},\n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n  }\n \n  getOptions() {\n    const options = [];\n    options.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n    console.log(\"tttttt getOptions\", options);\n    return Promise.resolve(options);\n  }  \n\n  removePart(parts, part) {\n    const index = _.indexOf(parts, part);\n    parts.splice(index, 1);\n  }\n\n  onFormatChanged() {\n    console.log(\"onFormatChanged\", this);\n    this.updateRestSql();\n  }\n\n  onTableChanged() {\n    console.log(\"tableChanged\", this);\n    this.target.table = this.target.tableSegment.value;\n    this.updateRestSql();\n  }\n\n  onJoinTableChanged(joinIndex) {\n    console.log(\"onJoinTableChanged\", joinIndex);\n    // this.target.joinQueryList[joinIndex].table = ;\n    this.updateRestSql();\n  }\n\n  onLimitChanged() {\n    // console.log(\"onLimitChanged\");\n    this.target.limit = this.target.limitSegment.value;\n    this.updateRestSql();\n  }\n\n  addSelectionAction(part, index) {\n    console.log(1111, part,index);\n    this.getOptions()\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.selectionsParts.push(express);\n    this.resetPlusButton(this.selectionAdd);\n\n  }\n\n  handleSelectionsPartEvent(part, index, event) {\n    console.log(\"tttttt handleSelectionsPartEvent\", event, index, part, '---');\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n     \n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.removePart(this.target.selectionsParts, part);\n      // this.target.selectionsParts.splice(index, 1, null);\n      this.updateRestSql()\n      console.log(this.target.selectionsParts, '------')\n    } else if (event.name === \"part-param-changed\") {\n      console.log(this.target.selectionsParts);\n      this.target.selectionsParts.forEach((item, i) => {\n      })\n      this.updateRestSql();\n    }\n  }\n\n  addJoinSelectionAction(joinIndex, expIndex) {\n    console.log(\"addJoinSelectionAction\", joinIndex, expIndex);\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    this.target.joinQueryList[joinIndex].selections.push(express)\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].selectionAdd);\n  }\n\n  handleJoinSelectionsPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinSelectionsPartEvent\", joinIndex, expIndex);\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // this.removePart(this.target.joinQueryList[joinIndex].selections, part);\n      this.target.joinQueryList[joinIndex].selections.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addWhereAction(part, index) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n\n    this.target.whereParts.push(express);\n  \n    this.resetPlusButton(this.whereAdd);\n  }\n\n  handleWherePartEvent(part, index, event) {\n    // console.log(\"handleWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.whereParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinWhereAction(joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'expression', params: ['column', '=', 'value'] });\n    console.log(\"addWhereAction\", express);\n    this.target.joinQueryList[joinIndex].where.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].whereAdd);\n  }\n\n  handleJoinWherePartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinWherePartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['=', '<', '<=', '>', '>=', 'CONTAINS', 'STARTSWITH', 'ENDSWITH', 'RANGE', 'IN'];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].where.splice(expIndex, 1);\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addAggAction() {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addAggAction\", express);\n    this.target.aggParts.push(express);\n    this.resetPlusButton(this.aggAdd);\n  }\n\n  handleAggPartEvent(part, index, event) {\n    console.log(\"handleAggPartEvent\");\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.aggParts.splice(index, 1)\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinAggAction(joinIndex) {\n    const express = sqlPart.create({ type: 'aggregate', params: ['avg', 'column'] });\n    console.log(\"addJoinAggAction\", express);\n    this.target.joinQueryList[joinIndex].aggs.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].aggAdd);\n  }\n\n  handleJoinAggPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinAggPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"agg\") {\n      // 暂时只支持展开操作符列表\n      const operators = event.param.options;\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].aggs.splice(expIndex, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addGroupAction() {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.groupParts.push(express);\n    this.resetPlusButton(this.groupAdd);\n  }\n\n  handleGroupPartEvent(part, index, event) {\n    console.log(\"handleGroupsPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.groupParts.splice(index, 1);\n      this.updateRestSql()\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinGroupAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'column', params: ['column'] });\n    console.log(\"addGroupsAction\", express);\n    this.target.joinQueryList[joinIndex].groups.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].groupAdd);\n  }\n\n  handleJoinGroupPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinGroupPartEvent\");\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].groups.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    }\n  }\n\n  addJoinOnAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'on', params: ['field', 'field'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].on.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].onAdd);\n  }\n\n  handleJoinOnPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinOnPartEvent\", event);\n    if (event.name === \"get-param-options\" && event.param.name === \"op\") {\n      // 暂时只支持展开操作符列表\n      const operators = ['='];\n      return Promise.resolve(this.uiSegmentSrv.newOperators(operators));\n    } else if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].on.splice(expIndex, 1);\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field1\") {\n      // on field1=field2，field1是join的表中的字段，field2是原始表中的字段，这里做成可选项\n      console.log(\"handleJoinOnPartEvent\", this.target.joinQueryList[joinIndex]);\n      const options = [];\n      this.target.joinQueryList[joinIndex].selections.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field2\") {\n      const options = [];\n      this.target.selectionsParts.forEach((part) => {\n        options.push(part[\"params\"][0]);\n      });\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addJoinExportAction(part, joinIndex, expIndex) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addJoinOnAction\", express);\n    this.target.joinQueryList[joinIndex].export.push(express);\n    this.resetPlusButton(this.target.joinQueryList[joinIndex].exportAdd);\n  }\n\n  handleJoinExportPartEvent(part, joinIndex, expIndex, event) {\n    console.log(\"handleJoinExportPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      this.target.joinQueryList[joinIndex].export.splice(expIndex, 1);\n      this.updateRestSql();\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      const options = this.getExportOptions(this.target.joinQueryList[joinIndex].selections, this.target.joinQueryList[joinIndex].aggs);\n      return Promise.resolve(this.uiSegmentSrv.newOperators(options));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addSortAction(index) {\n    const express = sqlPart.create({ type: 'sort', params: ['asc', 'field'] });\n    console.log(\"addSortAction\", index);\n    this.target.sortParts.push(express);\n    this.resetPlusButton(this.sortAdd);\n  }\n\n  handleSortPartEvent(part, index, event) {\n    console.log(\"handleSortPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n      // console.log(this.target.sortParts,'====');\n\n      this.target.sortParts.splice(index, 1);\n      this.updateRestSql();\n      // console.log(this.target.sortParts,'====');\n    } else if (event.name === \"get-param-options\" && event.param.name === \"field\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  addFieldAction(index) {\n    const express = sqlPart.create({ type: 'alias', params: ['fields', 'alias'] });\n    console.log(\"addSortAction\", index);\n    this.target.fieldParts.push(express);\n    this.resetPlusButton(this.fieldAdd);\n  }\n\n  handleFieldPartEvent(part, index, event) {\n    console.log(\"handleFieldPartEvent\", event);\n    if (event.name === \"get-part-actions\") {\n      return this.$q.when([{ text: 'Remove', value: 'remove' }]);\n    } else if (event.name === \"action\" && event.action.value === \"remove\") {\n\n      this.target.fieldParts.splice(index, 1);\n      this.updateRestSql();\n\n    } else if (event.name === \"get-param-options\") {\n      return Promise.resolve(this.uiSegmentSrv.newOperators(this.getAllFields()));\n    } else if (event.name === \"part-param-changed\") {\n      this.updateRestSql();\n    } else {\n      return Promise.resolve([]);\n    }\n  }\n\n  resetPlusButton(button) {\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    button.html = plusButton.html;\n    button.value = plusButton.value;\n  }\n\n  addJoin() {\n    const queryObj = {\n      type: \"left_join\",\n      table: this.uiSegmentSrv.newSegment({ \"value\": \"select table\", \"fake\": true }),\n      selections: [],\n      selectionAdd: this.uiSegmentSrv.newPlusButton(),\n      where: [],\n      whereAdd: this.uiSegmentSrv.newPlusButton(),\n      aggs: [],\n      aggAdd: this.uiSegmentSrv.newPlusButton(),\n      groups: [],\n      groupAdd: this.uiSegmentSrv.newPlusButton(),\n      on: [],\n      onAdd: this.uiSegmentSrv.newPlusButton(),\n      export: [],\n      exportAdd: this.uiSegmentSrv.newPlusButton()\n    };\n    this.target.joinQueryList.push(queryObj);\n    console.log(\"addJoin\", this.target.joinQueryList);\n  }\n  delJoin(index) {\n    this.target.joinQueryList.splice(index, 1)\n  }\n\n  getAllFields() {\n    // 获取select的字段，aggregate的字段，以及所有join表中的export字段\n\n    const mainFields = this.getExportOptions(this.target.selectionsParts, this.target.aggParts);\n    console.log(this.target.selectionsParts, '--------');\n    const exportFields = []\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"fafadsf1\", query.export)\n      query.export.forEach((part) => {\n        console.log(\"fafadsf2\", part);\n        exportFields.push(part.params[1]) // todo: 重复元素保护\n      });\n    });\n    return mainFields.concat(exportFields)\n  }\n\n  getExportOptions(selections, aggs) {\n    // 获取select的字段和aggs的字段并格式化为restSql格式\n    const options = [];\n    selections.forEach((part) => {\n      // export已经select的字段\n      options.push(part[\"params\"][0]);\n    });\n    aggs.forEach((part) => {\n      // export已经aggregation的字段\n      console.log(\"handleJoinExportPartEvent\", part);\n      const [aggFunc, field] = part.params;\n      options.push([field, aggFunc].join(\"__\"));\n    });\n    return options;\n  }\n\n  updateRestSql() {\n    // 将输入的内容更新到target中去\n\n    this.target.query = {\n      // restSql协议结构定义\n      \"select\": {\n        \"from\": \"\",\n        \"fields\": [],\n        \"filter\":{}, \n        \"group_by\": [],\n        \"aggregation\": [],\n        \"sort\": [],\n      },\n      \"join\": [],\n      \"sort\": [],\n      \"fields\": [],\n      \"limit\": 200\n    };\n\n    // udpate table\n    this.target.query.select.from = this.target.table;\n\n    // update select fields\n    this.target.selectionsParts.forEach((part) => {\n      this.target.query.select.fields.push(part.params[0]);\n    });\n\n    // update where\n    const operatorToSuffix = {\n      \"=\": \"\",\n      \"<\": \"__lt\",\n      \"<=\": \"__lte\",\n      \">\": \"__gt\",\n      \">=\": \"__gte\",\n      \"CONTAINS\": \"__contains\",\n      \"STARTSWITH\": \"__startswith\",\n      \"ENDSWITH\": \"__endswith\",\n      \"RANGE\": \"__range\",\n      \"IN\": \"__in\"\n    }\n    // [\"1\", \"=\", \"1\"]\n    this.target.whereParts.forEach((part) => {\n\n      const suffix = operatorToSuffix[part.params[1]];\n      const key = `${part.params[0]}${suffix}`\n      if (part.params[1] === \"IN\") {\n        console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n        this.target.query.select.filter[key] = JSON.parse(part.params[2]);\n       \n      } else {\n        if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n          const tmpStr = part.params[2]\n          this.target.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          // console.log(this.target.query.select);\n        } else if (!isNaN(parseFloat(part.params[2]))) {\n          this.target.query.select.filter[key] = parseFloat(part.params[2]);\n          console.log(this.target.query.select);\n        }\n        else if (part.params[2].toLowerCase() === \"true\" ) {          \n          this.target.query.select.filter[key] =true;\n        } else if (part.params[2].toLowerCase() === \"false\") {\n          this.target.query.select.filter[key] = false;\n        }\n        else {\n          return Promise.reject({\n            message: 'tetete',\n          });\n        }\n      }\n    });\n\n    // update aggregation\n    // todo:agg func无法修改, 无法删除\n    this.target.aggParts.forEach((part) => {\n      console.log(\"aggParts\", part);\n      const [aggFunc, field] = part.params;\n      this.target.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n    });\n\n    // update group by\n    this.target.groupParts.forEach((part) => {\n      console.log(\"groupParts\", part);\n      this.target.query.select.group_by.push(part.params[0]);\n    });\n\n    // update join\n    this.target.joinQueryList.forEach((query) => {\n      console.log(\"joinQueryList\", query);\n      const joinQuery = {};\n      // update join type\n      joinQuery.type = query.type;\n      joinQuery.query = { \"select\": {} };\n      console.log(\"joinQueryList\", query);\n      // update join table\n      joinQuery.query.select.from = query.table.value;\n      console.log(\"joinQueryList\", joinQuery.query.select.from);\n      // update join fields\n      joinQuery.query.select.fields = []\n      query.selections.forEach((part) => {\n        console.log(\"selections\", part);\n        joinQuery.query.select.fields.push(part.params[0]);\n      });\n      // udpate join filter\n      joinQuery.query.select.filter = {};\n      query.where.forEach((part) => {\n        const suffix = operatorToSuffix[part.params[1]];\n        const key = `${part.params[0]}${suffix}`;\n\n        if (part.params[1] === \"IN\") {\n          console.log(\"whereTest\", part.params[2], typeof part.params[2]);\n          joinQuery.query.select.filter[key] = JSON.parse(part.params[2]);\n        } else {\n          console.log(\"whereTest\", part.params[2]);\n          if ((part.params[2].startsWith(\"\\\"\") && part.params[2].endsWith(\"\\\"\")) || (part.params[2].startsWith(\"\\'\") && part.params[2].endsWith(\"\\'\"))) {\n            const tmpStr = part.params[2]\n            joinQuery.query.select.filter[key] = tmpStr.slice(1, tmpStr.length - 1);\n          } else if (!isNaN(parseFloat(part.params[2]))) {\n            joinQuery.query.select.filter[key] = parseFloat(part.params[2]);\n          } else {\n            return Promise.reject({\n              message: 'tetete',\n            });\n          }\n\n        }\n\n        console.log(\"joinfilter\", key, joinQuery.query.select.filter);\n      })\n      // update aggregation \n      // todo:agg func无法修改\n      joinQuery.query.select.aggregation = [];\n      query.aggs.forEach((part) => {\n        console.log(\"join_aggregation\", part);\n        const [aggFunc, field] = part.params;\n        joinQuery.query.select.aggregation.push([field, aggFunc].join(\"__\"));\n      });\n      // update join group by\n      joinQuery.query.select.group_by = [];\n      query.groups.forEach((part) => {\n        // console.log(\"join_group\", part);\n        joinQuery.query.select.group_by.push(part.params[0]);\n      });\n      // update join on\n      joinQuery.on = {};\n      query.on.forEach((part) => {\n        joinQuery.on[part.params[0]] = part.params[1];\n      });\n      // updaate export\n      joinQuery.export = [];\n      query.export.forEach((part) => {\n        console.log(\"joinQuery\");\n        joinQuery.export.push(part.params.join(\"@\"));\n      });\n      this.target.query.join.push(joinQuery);\n    });\n\n    // update sort\n    this.target.sortParts.forEach((part) => {\n      console.log(\"sortParts\", part);\n      const sortExp = part.params[0] === \"asc\" ? part.params[1] : `-${part.params[1]}`;\n      this.target.query.sort.push(sortExp);\n    });\n\n    //update fields\n    this.target.fieldParts.forEach((part) => {\n      // console.log(\"fieldParts\", part);\n      this.target.query.fields.push(part.params.join(\"@\"));\n    });\n\n    // update limit\n    this.target.query.limit = parseInt(this.target.limit);\n    // console.log(\"UpdateComplete\", this.target.query);\n    // this.datasource.metricFindQuery(this.target.query || '').then(this.panelCtrl.refresh());\n    // console.log(this.target, this.target.query);\n    this.target.target = JSON.stringify(this.target.query);\n    // this.target.target = this.target.query;\n\n    // console.log(this.target, this.target.query);\n    this.target.whereParts = this.target.whereParts;\n    // console.log(\"UpdateComplete\", this.target.selectionsParts);\n    // this.datasource.metricFindQuery(JSON.stringify(this.target.query) || '');\n    // this.datasource.query(this.target.query);\n    this.panelCtrl.refresh();\n\n  }\n}\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}